name: Build godotcoacd for iOS

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  ios:
    name: iOS (arm64/ ${{ matrix.target }})
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        target: [template_debug, template_release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure CMake for iOS
        run: |
          cmake -S . -B build \
            -G Xcode \
            --toolchain godot-cpp/cmake/ios.toolchain.cmake \
            -DPLATFORM=OS64 \
            -DGODOTCPP_TARGET=${{ matrix.target }}
            
      - name: Build
        run: cmake --build build --target godotcoacd --config Release --parallel
      
      - name: Configure CMake for iOS Simulator
        run: |
          cmake -S . -B build-sim \
            -G Xcode \
            --toolchain godot-cpp/cmake/ios.toolchain.cmake \
            -DPLATFORM=SIMULATORARM64 \
            -DGODOTCPP_TARGET=${{ matrix.target }}
            
      - name: Build
        run: cmake --build build-sim --target godotcoacd --config Release --parallel
      
      - name: Create XCFrameworks
        run: |
          xcodebuild -create-xcframework \
            -library build/bin/libgodotcoacd.ios.${{ matrix.target }}.arm64.a \
            -library build-sim/bin/libgodotcoacd.ios.${{ matrix.target }}.arm64.simulator.a \
            -output addons/godotcoacd/bin/libgodotcoacd.ios.${{ matrix.target }}.xcframework

          xcodebuild -create-xcframework \
            -library build/bin/libgodot-cpp.ios.${{ matrix.target }}.arm64.a \
            -library build-sim/bin/libgodot-cpp.ios.${{ matrix.target }}.arm64.a \
            -output addons/godotcoacd/bin/libgodot-cpp.ios.${{ matrix.target }}.xcframework
          
          xcodebuild -create-xcframework \
            -library build/CoACD-godot-src/Release-iphoneos/libcoacd.a \
            -library build-sim/CoACD-godot-src/Release-iphoneos/libcoacd.a \
            -output addons/godotcoacd/bin/libcoacd.ios.${{ matrix.target }}.xcframework
          
          xcodebuild -create-xcframework \
            -library build/_deps/spdlog-build/Release-iphoneos/libspdlog.a \
            -library build-sim/_deps/spdlog-build/Release-iphoneos/libspdlog.a \
            -output addons/godotcoacd/bin/libspdlog.ios.${{ matrix.target }}.xcframework

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godotcoacd-ios-${{ matrix.target }}
          path: addons/godotcoacd/bin/*
