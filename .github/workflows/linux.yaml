name: Build godotcoacd for Linux

on:
  workflow_dispatch:

jobs:
  linux:
    name: Linux (${{ matrix.arch }} / ${{ matrix.target }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x32, arm32, arm64, riscv32, riscv64]
        target: [template_debug, template_release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Install required compiler
        run: |
          case "${{ matrix.arch }}" in
            x64)
              sudo apt-get install -y gcc g++
              ;;
            x32)
              sudo apt-get install -y gcc-multilib g++-multilib
              ;;
            arm32)
              sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
              ;;
            arm64)
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              ;;
             riscv32)
              sudo apt-get install -y gcc-riscv32-unknown-elf g++-riscv32-unknown-elf
              ;;
            riscv64)
              sudo apt-get install -y gcc-riscv64-unknown-elf g++-riscv64-unknown-elf
              ;;
          esac

      - name: Configure CMake
        run: |
          case "${{ matrix.arch }}" in
            x64)
              export CC=gcc
              export CXX=g++
              export CFLAGS=""
              export CXXFLAGS=""
              export LDFLAGS=""
              CMAKE_SYSTEM_NAME_ARG=""
              CMAKE_SYSTEM_PROCESSOR_ARG=""
              ;;
            x32)
              export CC=gcc
              export CXX=g++
              export CFLAGS="-m32"
              export CXXFLAGS="-m32"
              export LDFLAGS="-m32"
              CMAKE_SYSTEM_NAME_ARG=""
              CMAKE_SYSTEM_PROCESSOR_ARG=""
              ;;
            arm32)
              export CC=arm-linux-gnueabihf-gcc
              export CXX=arm-linux-gnueabihf-g++
              export CFLAGS="-D_TIME_BITS=32"
              export CXXFLAGS="-D_TIME_BITS=32"
              export LDFLAGS=""
              CMAKE_SYSTEM_NAME_ARG="-DCMAKE_SYSTEM_NAME=Linux"
              CMAKE_SYSTEM_PROCESSOR_ARG="-DCMAKE_SYSTEM_PROCESSOR=arm"
              ;;
            arm64)
              export CC=aarch64-linux-gnu-gcc
              export CXX=aarch64-linux-gnu-g++
              export CFLAGS=""
              export CXXFLAGS=""
              export LDFLAGS=""
              CMAKE_SYSTEM_NAME_ARG="-DCMAKE_SYSTEM_NAME=Linux"
              CMAKE_SYSTEM_PROCESSOR_ARG="-DCMAKE_SYSTEM_PROCESSOR=aarch64"
              ;;
            riscv32)
              export CC=riscv32-unknown-elf-gcc
              export CXX=riscv32-unknown-elf-g++
              CMAKE_SYSTEM_NAME_ARG=""
              CMAKE_SYSTEM_PROCESSOR_ARG=""
              ;;
            riscv64)
              export CC=riscv64-unknown-elf-gcc
              export CXX=riscv64-unknown-elf-g++
              CMAKE_SYSTEM_NAME_ARG=""
              CMAKE_SYSTEM_PROCESSOR_ARG=""
              ;;
          esac

          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_C_FLAGS="$CFLAGS" \
            -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" \
            $CMAKE_SYSTEM_NAME_ARG \
            $CMAKE_SYSTEM_PROCESSOR_ARG \
            -DGODOTCPP_TARGET=${{ matrix.target }}

      - name: Build
        run: |
          cmake --build build --target godotcoacd -- -j$(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godotcoacd-linux-${{ matrix.arch }}-${{ matrix.target }}
          path: addons/godotcoacd/bin/*