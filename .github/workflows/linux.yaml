name: Build godotcoacd for Linux

on:
  workflow_dispatch:

jobs:
  linux:
    name: Linux (${{ matrix.arch }} / ${{ matrix.target }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x32, arm32, arm64]
        target: [template_debug, template_release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: Configure CMake
        run: |
          case "${{ matrix.arch }}" in
            x64)
              export CC=gcc
              export CXX=g++
              export CFLAGS=""
              export CXXFLAGS=""
              ;;
            x32)
              export CC=gcc
              export CXX=g++
              export CFLAGS="-m32"
              export CXXFLAGS="-m32"
              export LDFLAGS="-m32"
              ;;
            arm32)
              export CC=arm-linux-gnueabihf-gcc
              export CXX=arm-linux-gnueabihf-g++
              export CFLAGS=""
              export CXXFLAGS=""
              ;;
            arm64)
              export CC=aarch64-linux-gnu-gcc
              export CXX=aarch64-linux-gnu-g++
              export CFLAGS=""
              export CXXFLAGS=""
              ;;
          esac

          cmake -S . -B build \
            -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_C_FLAGS="$CFLAGS" \
            -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" \
            -DGODOTCPP_TARGET=${{ matrix.target }}

      - name: Build
        run: |
          cmake --build build --target godotcoacd -- -j$(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: godotcoacd-linux-${{ matrix.arch }}-${{ matrix.target }}
          path: addons/godotcoacd/bin/*